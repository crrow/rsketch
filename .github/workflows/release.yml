name: Release

permissions:
  contents: write

on:
  pull_request:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'
      - '[0-9]+.[0-9]+.[0-9]+*'

jobs:
  # Update version and changelog before building
  prepare-release:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from tag
        id: extract_version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION from tag: $TAG_NAME"

      - name: Install git-cliff
        uses: taiki-e/install-action@v2
        with:
          tool: git-cliff

      - name: Update Cargo.toml version
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"
          sed -i 's/^version = ".*"/version = "'"$VERSION"'"/' Cargo.toml
          echo "Updated Cargo.toml to version $VERSION"

      - name: Update CHANGELOG.md
        run: |
          git cliff --tag ${{ steps.extract_version.outputs.tag }} -o CHANGELOG.md
          echo "Updated CHANGELOG.md"

      - name: Commit version and changelog updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Cargo.toml CHANGELOG.md
          git commit -m "chore(release): prepare for ${{ steps.extract_version.outputs.tag }} [skip ci]" || echo "No changes to commit"
          git push origin HEAD:main

  # Build all platform-specific artifacts using cargo-zigbuild on Linux
  build:
    needs: prepare-release
    if: always() && (needs.prepare-release.result == 'success' || needs.prepare-release.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0
          submodules: recursive

      - name: Pull latest changes
        run: git pull origin main

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install protoc
        uses: arduino/setup-protoc@c65c819552d16ad3c9b72d9dfd5ba5237b9c906b # v3.0.0
        with:
          version: '25.x'
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install cargo-zigbuild
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-zigbuild

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.13.0

      - name: Add Rust targets
        run: |
          rustup target add aarch64-apple-darwin
          rustup target add x86_64-apple-darwin
          rustup target add x86_64-unknown-linux-gnu
          rustup target add x86_64-unknown-linux-musl

      - name: Build all targets
        run: |
          cargo zigbuild --release --target aarch64-apple-darwin
          cargo zigbuild --release --target x86_64-apple-darwin
          cargo zigbuild --release --target x86_64-unknown-linux-gnu
          cargo zigbuild --release --target x86_64-unknown-linux-musl

      - name: Package artifacts
        run: |
          mkdir -p artifacts

          # Package each target
          for target in aarch64-apple-darwin x86_64-apple-darwin x86_64-unknown-linux-gnu x86_64-unknown-linux-musl; do
            cd target/$target/release
            tar czf ../../../artifacts/rsketch-$target.tar.gz rsketch
            cd ../../..

            # Add additional files to the archive
            tar rzf artifacts/rsketch-$target.tar.gz CHANGELOG.md LICENSE README.md

            # Generate checksum
            cd artifacts
            sha256sum rsketch-$target.tar.gz > rsketch-$target.tar.gz.sha256
            cd ..
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: artifacts/*

  # Create GitHub Release
  release:
    needs: [prepare-release, build]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install git-cliff
        uses: taiki-e/install-action@v2
        with:
          tool: git-cliff

      - name: Generate release notes
        run: |
          git cliff --latest --strip all > RELEASE_NOTES.md
          echo "Release notes generated:"
          cat RELEASE_NOTES.md

      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          name: release-artifacts
          path: artifacts

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ github.ref_name }} \
            --title "${{ github.ref_name }}" \
            --notes-file RELEASE_NOTES.md \
            artifacts/*
